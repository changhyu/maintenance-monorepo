name: Deploy Automation

on:
  push:
    branches: [main, develop, release/*]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ (dev, staging, prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      version:
        description: 'ë°°í¬ ë²„ì „ (ê¸°ë³¸ê°’ì€ latest)'
        required: false
        default: 'latest'
      rollback:
        description: 'ë¡¤ë°± ìˆ˜í–‰ ì—¬ë¶€'
        required: false
        default: 'false'
        type: boolean

jobs:
  validate:
    name: ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      version: ${{ steps.set-version.outputs.version }}
    
    steps:
      - name: ë¸Œëœì¹˜/íƒœê·¸ ê¸°ë°˜ í™˜ê²½ ì„¤ì •
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release/.* ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v.* ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: ë²„ì „ ì„¤ì •
        id: set-version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "latest" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v.* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: ë°°í¬ í™˜ê²½ ë° ë²„ì „ ì¶œë ¥
        run: |
          echo "ğŸš€ ë°°í¬ í™˜ê²½: ${{ steps.set-env.outputs.environment }}"
          echo "ğŸ“¦ ë°°í¬ ë²„ì „: ${{ steps.set-version.outputs.version }}"

  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.rollback != 'true'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
      
      - name: Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Node.js ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci
      
      - name: Python í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          pytest backend/tests/
      
      - name: Frontend í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          npm test

  build:
    name: ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: always() && (needs.test.result == 'success' || github.event.inputs.rollback == 'true')
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2
      
      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          chmod +x scripts/setup_env.sh
          ./scripts/setup_env.sh ${{ needs.validate.outputs.environment }}
      
      - name: API ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/maintenance-api:${{ needs.validate.outputs.version }}
            ${{ secrets.DOCKER_REGISTRY }}/maintenance-api:${{ needs.validate.outputs.version }}-${{ steps.timestamp.outputs.timestamp }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/maintenance-api:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/maintenance-api:buildcache,mode=max
      
      - name: Frontend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/maintenance-frontend:${{ needs.validate.outputs.version }}
            ${{ secrets.DOCKER_REGISTRY }}/maintenance-frontend:${{ needs.validate.outputs.version }}-${{ steps.timestamp.outputs.timestamp }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/maintenance-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/maintenance-frontend:buildcache,mode=max

  deploy-dev:
    name: ê°œë°œ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always() && needs.build.result == 'success' && needs.validate.outputs.environment == 'dev'
    
    steps:
      - name: SSHë¡œ ì„œë²„ ì—°ê²° ë° ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/maintenance-monorepo
            git pull
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh dev ${{ needs.validate.outputs.version }}

  deploy-staging:
    name: ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always() && needs.build.result == 'success' && needs.validate.outputs.environment == 'staging'
    
    steps:
      - name: SSHë¡œ ì„œë²„ ì—°ê²° ë° ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/maintenance-monorepo
            git pull
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh staging ${{ needs.validate.outputs.version }}

  deploy-prod:
    name: í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always() && needs.build.result == 'success' && needs.validate.outputs.environment == 'prod'
    environment: production # ìŠ¹ì¸ ìš”êµ¬ë¥¼ ìœ„í•œ environment ì„¤ì •
    
    steps:
      - name: SSHë¡œ ì„œë²„ ì—°ê²° ë° ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/maintenance-monorepo
            git pull
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh prod ${{ needs.validate.outputs.version }}

  rollback:
    name: ë¡¤ë°± ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.rollback == 'true'
    
    steps:
      - name: í™˜ê²½ì— ë”°ë¥¸ ë¡¤ë°± ì„¤ì •
        id: rollback-config
        run: |
          if [[ "${{ needs.validate.outputs.environment }}" == "prod" ]]; then
            echo "host=${{ secrets.PROD_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "user=${{ secrets.PROD_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.validate.outputs.environment }}" == "staging" ]]; then
            echo "host=${{ secrets.STAGING_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "user=${{ secrets.STAGING_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.STAGING_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
          else
            echo "host=${{ secrets.DEV_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "user=${{ secrets.DEV_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
          fi
      
      - name: SSHë¡œ ì„œë²„ ì—°ê²° ë° ë¡¤ë°± ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ steps.rollback-config.outputs.host }}
          username: ${{ steps.rollback-config.outputs.user }}
          key: ${{ steps.rollback-config.outputs.key }}
          script: |
            cd /opt/maintenance-monorepo
            ./scripts/rollback.sh ${{ needs.validate.outputs.environment }} ${{ needs.validate.outputs.version }}

  notify:
    name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [validate, build, deploy-dev, deploy-staging, deploy-prod, rollback]
    if: always()
    
    steps:
      - name: ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ í™•ì¸
        id: check-status
        run: |
          if [[ "${{ needs.validate.outputs.environment }}" == "prod" ]]; then
            DEPLOY_JOB_STATUS="${{ needs.deploy-prod.result }}"
          elif [[ "${{ needs.validate.outputs.environment }}" == "staging" ]]; then
            DEPLOY_JOB_STATUS="${{ needs.deploy-staging.result }}"
          elif [[ "${{ needs.validate.outputs.environment }}" == "dev" ]]; then
            DEPLOY_JOB_STATUS="${{ needs.deploy-dev.result }}"
          elif [[ "${{ github.event.inputs.rollback }}" == "true" ]]; then
            DEPLOY_JOB_STATUS="${{ needs.rollback.result }}"
          else
            DEPLOY_JOB_STATUS="skipped"
          fi
          
          echo "deploy_status=$DEPLOY_JOB_STATUS" >> $GITHUB_OUTPUT
          
          if [[ "$DEPLOY_JOB_STATUS" == "success" ]]; then
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_text=ì„±ê³µ" >> $GITHUB_OUTPUT
          elif [[ "$DEPLOY_JOB_STATUS" == "skipped" ]]; then
            echo "status_emoji=â­ï¸" >> $GITHUB_OUTPUT
            echo "status_text=ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
          else
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_text=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi
      
      - name: Slack ì•Œë¦¼ ì „ì†¡
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: ${{ steps.check-status.outputs.deploy_status == 'success' && 'good' || steps.check-status.outputs.deploy_status == 'skipped' && 'warning' || 'danger' }}
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_TITLE: ë°°í¬ ê²°ê³¼
          SLACK_MESSAGE: |
            ${{ steps.check-status.outputs.status_emoji }} *ë°°í¬ ${{ steps.check-status.outputs.status_text }}*
            
            *í™˜ê²½:* ${{ needs.validate.outputs.environment }}
            *ë²„ì „:* ${{ needs.validate.outputs.version }}
            *íƒ€ì„ìŠ¤íƒ¬í”„:* $(date +"%Y-%m-%d %H:%M:%S")
            *ì»¤ë°‹:* ${{ github.sha }}
            *íŠ¸ë¦¬ê±°:* ${{ github.event_name }}
            *ì›Œí¬í”Œë¡œìš°:* ${{ github.workflow }}
            
            [ë°°í¬ ìƒì„¸ ì •ë³´](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          SLACK_USERNAME: GitHub Actions