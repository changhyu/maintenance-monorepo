name: ë³´ì•ˆ íŒ¨ì¹˜ ìžë™í™”

on:
  schedule:
    - cron: '0 1 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ 01:00 UTCì— ì‹¤í–‰
  workflow_dispatch:    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •

jobs:
  security-patch:
    name: ë³´ì•ˆ íŒ¨ì¹˜ ì ìš© ë° ê²€ì¦
    runs-on: ubuntu-latest
    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
        run: npm run security:fix:all
        
      - name: íŒ¨ì¹˜ ê²€ì¦
        run: npm run security:verify
        
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run security:test
        
      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: git-check
        run: |
          git status
          git diff --name-only
          echo "::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)"

      - name: ë³´ì•ˆ íŒ¨ì¹˜ PR ìƒì„±
        if: steps.git-check.outputs.modified == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ë³´ì•ˆ: ìžë™ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©"
          title: "ðŸ”’ ìžë™ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©"
          body: |
            ## ë³´ì•ˆ íŒ¨ì¹˜ ìžë™ ì ìš©

            ì´ PRì€ ìžë™í™”ëœ ë³´ì•ˆ íŒ¨ì¹˜ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ì ìš©ëœ íŒ¨ì¹˜:
            - ì·¨ì•½í•œ íŒ¨í‚¤ì§€ ì˜ì¡´ì„± íŒ¨ì¹˜
            - ì½”ë“œ ë ˆë²¨ ë³´ì•ˆ íŒ¨ì¹˜
            - npm overrides ì„¤ì • ì—…ë°ì´íŠ¸
            
            ### ê²€ì¦ ê²°ê³¼:
            - ìžë™í™”ëœ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ í†µê³¼
            - ì´ PRì„ ë³‘í•©í•´ë„ ê¸°ì¡´ ê¸°ëŠ¥ì´ ì†ìƒë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            ìƒì„¸ ë‚´ìš©ì€ `.security-patches/` ë””ë ‰í† ë¦¬ì˜ ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.
          branch: security/auto-patching
          base: main
          delete-branch: true
          labels: |
            security
            automated-pr
            dependencies

      - name: ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ë³´ì•ˆ íŒ¨ì¹˜ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### íŒ¨ì¹˜ ì ìš© ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.git-check.outputs.modified }}" == "true" ]; then
            echo "âœ… ë³´ì•ˆ íŒ¨ì¹˜ê°€ ì ìš©ë˜ì—ˆìœ¼ë©°, PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ ì ìš©í•  ë³´ì•ˆ íŒ¨ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ìµœì‹  ìƒíƒœìž…ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë§ˆì§€ë§‰ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
          echo "$(date)" >> $GITHUB_STEP_SUMMARY